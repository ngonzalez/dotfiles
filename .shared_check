#! /bin/bash
cd $1
grp="TC"
currenttime=$(date "+%Y.%m.%d-%H.%M.%S")
file1="/tmp/sc1-filecheck-$currenttime"
file2="/tmp/sc2-filecheck-$currenttime"
ext='\.(wav|aif|aiff|flac|mp3|m4a)'
if [[ `ls | grep "\[$grp\]" --colour=never | wc -l | bc` > 0 ]]; then
  true
else
  playlist=`ls | grep -E '^0{2,3}' --colour=never | grep '\.m3u' --colour=never`
  if [ $playlist ]; then
    if [ -f $playlist ]; then
      ls -1a | grep -E --colour=never $ext > $file1
      cat $playlist | grep -E --colour=never $ext > $file2
      if [ `diff -i -B --strip-trailing-cr $file1 $file2 | wc -l | bc` == 0 ]; then
        count=`cat $file1 | wc -l | bc`
        if [[ `/usr/local/bin/cfv` =~ "$count OK" ]]; then
          last_file=`cat $file1 | tail -n 1`
          date=`/usr/bin/GetFileInfo -m $last_file`
          genre=`/usr/local/bin/mp3info -p %g $last_file`
          name="[$grp] $genre - $count files OK [$grp]"
          mkdir "$name"
          `/usr/bin/SetFile -d "$date" "$name"
          `/usr/bin/SetFile -m "$date" "$name"
        else
          mkdir "[$grp] CRC Error [$grp]"
        fi
      else
        mkdir "[$grp] Missing files [$grp]"
      fi
      if [ -f $file1 ]; then
        rm -f $file1
      fi
      if [ -f $file2 ]; then
        rm -f $file2
      fi
    fi
  fi
fi